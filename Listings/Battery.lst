C51 COMPILER V9.54   BATTERY                                                               04/01/2016 10:06:44 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE BATTERY
OBJECT MODULE PLACED IN .\Objects\Battery.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil_v5\C51\BIN\C51.EXE Battery.c ROM(COMPACT) OPTIMIZE(8,SPEED) BROWSE DEBU
                    -G OBJECTEXTEND PRINT(.\Listings\Battery.lst) TABS(3) OBJECT(.\Objects\Battery.obj)

line level    source

   1          /*------------------------------------------------------------------*-
   2             A.C (v1.00)
   3            ------------------------------------------------------------------
   4             Simple switch interface code, with software debounce.
   5          
   6             COPYRIGHT
   7             ---------
   8             This code is copyright (c) 2001 by Richard Zhang.
   9          -*------------------------------------------------------------------*/
  10          
  11          #include "Main.h"
  12          #include "Port.h"
  13          
  14          #include "Battery.h"
  15          #include "Speech.h"
  16          
  17          // ------ Public variable definitions ------------------------------
  18          extern tByte Speech_time;
  19          
  20          // ------ Public variable declarations -----------------------------
  21          
  22          // ------ Private variables ----------------------------------------
  23          tWord u16ADCL;
  24          tWord u16ADC;
  25          tWord Battery_ADC_result;
  26          tByte Battery_level;
  27          
  28          // ------ Private constants ----------------------------------------
  29          
  30          /*------------------------------------------------------------------*-
  31            Battery_Init()
  32            Initialisation function for the switch library.
  33          -*------------------------------------------------------------------*/
  34          void Battery_Init(void)
  35             {
  36   1         // Disable digital function for P0.6
  37   1         P0DIDS |= 0x40;
  38   1         // ADC0(P0.6) is input-only mode
  39   1         P0M1 |= 0x40;
  40   1         P0M2 &= 0xbf;
  41   1         // Select channel 6 for conversion.
  42   1         AADR2 = 1;
  43   1         AADR1 = 0;
  44   1         AADR0 = 1;
  45   1         // Open interruption
  46   1         EADC = 1;
  47   1         // Open ADC function
  48   1         ADCCON1 |= 0x80;
  49   1         }
  50          
  51          /*------------------------------------------------------------------*-
  52            Battery_detection()
  53            Initialisation function for the switch library.
  54            1 minute/ticket.
C51 COMPILER V9.54   BATTERY                                                               04/01/2016 10:06:44 PAGE 2   

  55          -*------------------------------------------------------------------*/
  56          void Battery_detection(void)
  57             {
  58   1         // Get the battery voltage every minute.
  59   1         ADCI = 0;      // Clear ADC flag (ADCI = 0)
  60   1         ADCS = 1;      // ADC run (ADCS = 1)
  61   1      
  62   1      // Test battery 0x320, 3.28/4.15.
  63   1      // if(Battery_ADC_result >= 0x320)
  64   1         // PIN20 is 3.3V.
  65   1         // PIN21 voltage is 4.2V battery, it will change as time.
  66   1         // Set low voltage is 3.3V/3.6V = 0.92, 0.92*1024=938(0x3aa)
  67   1         if(Battery_ADC_result >= 0x3aa)
  68   1            {
  69   2            // clear speech time for tick voice, broadcast tich speech in 100ms.
  70   2            Speech_time = 0;     
  71   2            Goto_speech(Tick);
  72   2            }
  73   1         }
  74          
  75          /*------------------------------------------------------------------*-
  76            ADC_ISR()
  77            Initialisation function for the switch library.
  78          -*------------------------------------------------------------------*/
  79          void ADC_ISR(void) interrupt 11
  80             {
  81   1         ADCI = 0;      // Clear ADC flag (ADCI = 0)
  82   1         ADCS = 0;      // ADC stop (ADCS = 0)
  83   1         u16ADCL = ADCCON0;
  84   1         u16ADCL = u16ADCL >> 6;                // ADC[1:0]
  85   1      
  86   1         u16ADC = ADCH;
  87   1         u16ADC = (u16ADC << 2 ) + u16ADCL;     // ADC[9:2] + ADC[1:0]
  88   1         
  89   1         // Get the battery voltage every minute.
  90   1         Battery_ADC_result = u16ADC;
  91   1         }
  92          
  93          /*------------------------------------------------------------------*-
  94            ---- END OF FILE -------------------------------------------------
  95          -*------------------------------------------------------------------*/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    131    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
