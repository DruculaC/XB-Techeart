C51 COMPILER V9.54   IIC                                                                   04/22/2016 14:54:24 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE IIC
OBJECT MODULE PLACED IN .\Objects\IIC.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil_v5\C51\BIN\C51.EXE IIC.c ROM(COMPACT) OPTIMIZE(8,SPEED) BROWSE DEBUG OB
                    -JECTEXTEND PRINT(.\Listings\IIC.lst) TABS(3) OBJECT(.\Objects\IIC.obj)

line level    source

   1          /*------------------------------------------------------------------*-
   2             IIC.C (v1.00)
   3            ------------------------------------------------------------------
   4             IIC program for other program.
   5          
   6             COPYRIGHT
   7             ---------
   8             This code is copyright (c) 2016 by Richard Zhang.
   9          -*------------------------------------------------------------------*/
  10          
  11          #include "Main.h"
  12          #include "Port.h"
  13          
  14          #include "IIC.h"
  15          #include "Delay.h"
  16          
  17          // ------ Public variable definitions ------------------------------
  18          
  19          // ------ Public variable declarations -----------------------------
  20          
  21          // ------ Private variables ----------------------------------------
  22          tByte IIC_buffer[8];    // IIC buffer data.
  23          
  24          // ------ Private constants ----------------------------------------
  25          
  26          
  27          /*------------------------------------------------------------------*-
  28            IIC_Init()
  29            Program for IIC send a whole byte, include start stop and ack
  30          void IIC_Init(void)
  31             {
  32             }
  33          -*------------------------------------------------------------------*/
  34          
  35          /*------------------------------------------------------------------*-
  36            Single_Write_IIC()
  37            Program for IIC send a whole byte, include start stop and ack
  38          -*------------------------------------------------------------------*/
  39          void Single_Write_IIC(tByte REG_Address, tByte REG_data)
  40             {
  41   1         IIC_Start();                  //起始信号
  42   1         IIC_SendByte(SlaveAddress);   //发送设备地址+写信号
  43   1         IIC_SendByte(REG_Address);    //内部寄存器地址
  44   1         IIC_SendByte(REG_data);       //内部寄存器数据
  45   1         IIC_Stop();                   //发送停止信号
  46   1         }
  47          
  48          /*------------------------------------------------------------------*-
  49            Single_Read_IIC()
  50            Program for IIC read a whole byte, include start stop and ack
  51          -*------------------------------------------------------------------*/
  52          tByte Single_Read_IIC(tByte REG_Address)
  53             {  
  54   1         tByte REG_data;
C51 COMPILER V9.54   IIC                                                                   04/22/2016 14:54:24 PAGE 2   

  55   1         IIC_Start();                          //起始信号
  56   1         IIC_SendByte(SlaveAddress);           //发送设备地址+写信号
  57   1         IIC_SendByte(REG_Address);            //发送存储单元地址，从0开始 
  58   1         IIC_Start();                          //起始信号
  59   1         IIC_SendByte(SlaveAddress+1);         //发送设备地址+读信号
  60   1         REG_data = IIC_RecvByte();            //读出寄存器数据
  61   1         IIC_SendACK(1);
  62   1         IIC_Stop();                           //停止信号
  63   1         return REG_data; 
  64   1         }
  65          
  66          /*------------------------------------------------------------------*-
  67            Multiple_read_IIC()
  68            Program for IIC read a whole byte, include start stop and ack
  69          void Multiple_read_IIC(tByte Start_add, tByte Read_count)
  70          {   
  71             tByte i;
  72             IIC_Start();                           //起始信号
  73             IIC_SendByte(SlaveAddress);            //发送设备地址+写信号
  74             IIC_SendByte(Start_add);               //发送存储单元地址，从0x01开始   
  75             IIC_Start();                           //起始信号
  76             IIC_SendByte(SlaveAddress+1);          //发送设备地址+读信号
  77             for (i=0; i<Read_count; i++)           //连续读取6个地址数据，存储中BUF
  78                {
  79                IIC_buffer[i] = IIC_RecvByte();     //IIC_buffer[0]存储0x32地址中的数据
  80                if (i == Read_count-1)
  81                   {
  82                   IIC_SendACK(1);                  //最后一个数据需要回NOACK
  83                   }
  84                else
  85                   {
  86                   IIC_SendACK(0);                  //回应ACK
  87                   }
  88                }
  89             IIC_Stop();                            //停止信号
  90             Delay(LOOP_TIMEOUT_INIT_005ms);
  91             }
  92          -*------------------------------------------------------------------*/
  93          
  94          /*------------------------------------------------------------------*-
  95            IIC_SendByte()
  96            Program for IIC send a byte.
  97          -*------------------------------------------------------------------*/
  98          void IIC_SendByte(tByte dat)
  99             {
 100   1         tByte i;
 101   1         for (i=0; i<8; i++)        //8位计数器
 102   1            {
 103   2            dat <<= 1;              //移出数据的最高位
 104   2            SDA = CY;               //送数据口
 105   2            SCL = 1;                //拉高时钟线
 106   2            Delay5us();             //延时
 107   2            SCL = 0;                //拉低时钟线
 108   2            Delay5us();             //延时
 109   2            }
 110   1         IIC_RecvACK();
 111   1         }
 112          
 113          /*------------------------------------------------------------------*-
 114            IIC_RecvByte()
 115            Program for IIC receive a byte.
 116          -*------------------------------------------------------------------*/
C51 COMPILER V9.54   IIC                                                                   04/22/2016 14:54:24 PAGE 3   

 117          tByte IIC_RecvByte()
 118             {
 119   1         tByte i;
 120   1         tByte dat = 0;
 121   1      
 122   1         SDA = 1;                   //使能内部上拉,准备读取数据,
 123   1         for (i=0; i<8; i++)        //8位计数器
 124   1            {
 125   2            dat <<= 1;
 126   2            SCL = 1;                //拉高时钟线
 127   2            Delay5us();             //延时
 128   2            dat |= SDA;             //读数据               
 129   2            SCL = 0;                //拉低时钟线
 130   2            Delay5us();             //延时
 131   2            }
 132   1         return dat;
 133   1         }
 134          
 135          /*------------------------------------------------------------------*-
 136            IIC_Start()
 137            Program for IIC start signal.
 138          -*------------------------------------------------------------------*/
 139          void IIC_Start()
 140             {
 141   1         SDA = 1;
 142   1         SCL = 1;
 143   1         Delay5us();
 144   1         SDA = 0;
 145   1         Delay5us();
 146   1         SCL = 0;
 147   1         }
 148          
 149          /*------------------------------------------------------------------*-
 150            IIC_Stop()
 151            Program for IIC stop signal.
 152          -*------------------------------------------------------------------*/
 153          void IIC_Stop()
 154             {
 155   1         SDA = 0;
 156   1         SCL = 1;
 157   1         Delay5us();
 158   1         SDA = 1;
 159   1         Delay5us();
 160   1         }
 161          
 162          /*------------------------------------------------------------------*-
 163            IIC_SendACK()
 164            Program for IIC send ACK signal.
 165          -*------------------------------------------------------------------*/
 166          void IIC_SendACK(bit ack)
 167             {
 168   1         SDA = ack;
 169   1         SCL = 1;
 170   1         Delay5us();
 171   1         SCL = 0;
 172   1         Delay5us();
 173   1         }
 174          
 175          /*------------------------------------------------------------------*-
 176            IIC_RecvACK()
 177            Program for IIC receive ACK signal.
 178          -*------------------------------------------------------------------*/
C51 COMPILER V9.54   IIC                                                                   04/22/2016 14:54:24 PAGE 4   

 179          bit IIC_RecvACK()
 180             {
 181   1         SCL = 1;
 182   1         Delay5us();
 183   1         CY = SDA;
 184   1         SCL = 0;
 185   1         Delay5us();
 186   1         return CY;
 187   1         }
 188          
 189          /*------------------------------------------------------------------*-
 190            ---- END OF FILE -------------------------------------------------
 191          -*------------------------------------------------------------------*/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    194    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      8       8
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
